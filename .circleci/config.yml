version: 2.1


orbs:
  win: circleci/windows@2.2.0


workflows:
  build:
    jobs:
      - build-windows-pyinstaller-commercial


jobs:
  build-windows-pyinstaller-commercial:
    executor:
      name: win/default
      shell: powershell.exe
    steps:
      - checkout
      - win-install-sys-deps:
          ffmpeg-version: ""
          gstreamer-version: ""
          python-version: "3.8.8"
          qt-version: "5.15.2"
#      - win-install-python-deps:
#          poetry-version: "1.1.4"

commands:

  win-install-ffmpeg:
    parameters:
      ffmpeg-version:
        type: string
    steps:
      - run: echo 1

  win-install-gstreamer:
    parameters:
      gstreamer-version:
        type: string
    steps:
      - run: echo 1

  win-install-python:
    parameters:
      python-version:
        type: string
      install-location:
        type: string
        default: "C:/Program Files/"
    steps:
      - restore_cache:
          keys:
            - python-v2-<< parameters.python-version >>
      - run: |
          nuget install python -Version << parameters.python-version >> -ExcludeVersion -OutputDirectory "<< parameters.install-location >>"
          << parameters.install-location >>/Python/tools/python.exe --version
          << parameters.install-location >>/Python/tools/pip.exe --version
      - save_cache:
          paths:
            - << parameters.install-location >>
          key: python-v2-<< parameters.python-version >>

  win-install-qt:
    parameters:
      qt-version:
        type: string
      install-dir:
        type: string
        default: "C:/Program Files/Qt/"
      arch:
        type: string
        default: win64_msvc2019_64
    steps:
      - restore_cache:
          keys:
            - qt-v0-<< parameters.qt-version >>-<< parameters.arch >>
      - run: |
          pip install aqtinstall
          aqt install --outputdir "<< parameters.install-dir >>" << parameters.qt-version >> windows desktop << parameters.arch >>
      - save_cache:
          paths:
            - << parameters.install-dir >>
          key: qt-v0-<< parameters.qt-version >>-<< parameters.arch >>


  win-install-sys-deps:
    parameters:
      gstreamer-version:
        type: string
      ffmpeg-version:
        type: string
      python-version:
        type: string
      qt-version:
        type: string
    steps:
      - win-install-python:
          python-version: << parameters.python-version >>
      - win-install-qt:
          qt-version: << parameters.qt-version >>
      - win-install-gstreamer:
          gstreamer-version: << parameters.gstreamer-version >>
      - win-install-ffmpeg:
          ffmpeg-version: << parameters.ffmpeg-version >>
